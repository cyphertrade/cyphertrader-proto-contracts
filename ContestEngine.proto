syntax = "proto3";
package contest_engine;

import "google/protobuf/empty.proto";

enum ContestEngineErrorType {
  DatabaseError = 0;
  NoSqlError = 1;
  EvalExpError = 2;

  ContestValidationInvalidCreatorCommission = 3;
  ContestValidationMinParticipantsTooLow = 4;
  ContestValidationMinParticipantsTooHigh = 5;
  ContestValidationMaxParticipantsTooLow = 6;
  ContestValidationMaxParticipantsTooHigh = 7;
  ContestValidationMinParticipantsGreaterThanMax = 8;
  ContestValidationInvalidLeverage = 9;
  ContestValidationInitialBalanceTooLow = 10;
  ContestValidationInitialBalanceTooHigh = 11;
  ContestValidationDurationTooLow = 12;
  ContestValidationDurationTooHigh = 13;
  ContestValidationBuyInTooLow = 14;
  ContestValidationBuyInTooHigh = 15;
  ContestValidationInvalidAllowedAsset = 16;
  ContestValidationInvalidAllowedDifficulty = 17;
  ContestValidationInvalidBroker = 18;
  ContestValidationInitialPrizePoolTooHigh = 19;
  ContestValidationMinTeamSizeGreaterThanMax = 20;
  ContestValidationInvalidName = 21;
  ContestValidationInvalidContestId = 22;
  ContestValidationInvalidUserId = 23;
  ContestValidationContestStartDateInvalid = 24;

  InstrumentGroupNotFound = 25;
  BrokerNotFound = 26;
  InstrumentNotFound = 27;
  DifficultyNotFound = 28;

  // Registration / start rules
  ContestAlreadyStarted = 29;
  ContestRegistrationCancellationNotAllowed = 30;
  ContestRegistrationNotFound = 31;
  ContestMaxParticipantsExceeded = 32;

  // Entity not found errors
  UserNotFound = 33;
  UserGroupNotFound = 34;
  TraderProfileNotFound = 35;
  ContestSettingsNotFound = 36;
  ContestNotFound = 37;
  ContestAccountNotFound = 38;
  CreatorWalletNotFound = 39;

  // External service errors
  XpEngineError = 40;
  WalletGrpcError = 41;
  BrokerIntegrationGrpcError = 42;

  // Contest status validation errors
  InvalidContestStatusForPublish = 43;
  InvalidContestStatusForCancel = 44;
  InvalidContestStatusForUpdate = 45;
  InvalidContestStatusForRegistration = 46;

  // Contest account errors
  ContestAccountMismatch = 47;
  ValidationError = 48;
  ContestValidationMinTeamSizeOutOfRange = 49;
  ContestValidationMaxTeamSizeExceedsMaxParticipants = 50;
}

message ContestEngineContestRewardProgressive{
  double reward_decay = 1;
  uint32 winnable_places = 2;
}

message ContestEngineContestRewardFixed{
  map<uint32, double> places = 1;
}

message ContestEngineContestRewardSetupGrpcModel{
    oneof reward{
      ContestEngineContestRewardProgressive Progressive = 1;
      ContestEngineContestRewardFixed Fixed = 2;
    }
}

enum ContestEngineContestRegistrationStatus {
  Registered = 0;
  Canceled = 1;
}

message ContestEngineErrorGrpcModel {
  ContestEngineErrorType ErrorType = 1;
  optional string Message = 2;
}

message ContestEngineErrorsGrpcModel {
  repeated ContestEngineErrorGrpcModel Errors = 1;
}

enum ContestEngineContestGrpcStatus {
  Draft = 0;
  RegistrationOpen = 1;
  Active = 2;
  ContestCanceled = 3;
  Failed = 4;
  Ended = 5;
}

message ContestEngineContestGrpcModel {
  string Id = 1;
  string Name = 2;
  string CreatorUserId = 3;

  double PlatformCommissionPercent = 4;
  double CreatorCommissionPercent = 5;

  uint32 MinParticipants = 6;
  uint32 MaxParticipants = 7;

  double ContestLeverage = 8;
  double ContestInitialBalance = 9;

  uint32 ContestDurationMin = 10;
  optional uint64 BuyIn = 11;

  repeated string AllowedAssets = 12;
  string AllowedDifficulty = 13;

  string Broker = 14;
  optional uint64 InitialPrizePool = 15;

  uint64 ContestStartDateTimeUnixMs = 16;
  ContestEngineContestGrpcStatus Status = 17;

  optional uint32 MinTeamSize = 18;
  optional uint32 MaxTeamSize = 19;

  // unified naming with request (was FillInstantStart)
  bool AutoStartWhenFull = 20;

  ContestEngineContestRewardSetupGrpcModel RewardConfiguration = 21;
  optional string Description = 22;
}

message ContestEngineContestRegistrationGrpcModel {
  string UserId = 1;
  string ContestAccount = 2;
  ContestEngineContestRegistrationStatus Status = 3;

  // extra audit fields (optional but useful)
  optional uint64 JoinedAtUnixMs = 4;
  optional uint64 CanceledAtUnixMs = 5;
}


message ContestEngineCreateContestGrpcRequest {
  string UserId = 1;
  string Name = 2;
  double CreatorCommission = 3;

  // FIX: counts should be integers
  uint32 MinParticipants = 4;
  uint32 MaxParticipants = 5;

  optional uint32 MinTeamSize = 6;
  optional uint32 MaxTeamSize = 7;

  double ContestLeverage = 8;
  double ContestInitialBalance = 9;

  uint32 ContestDurationMinutes = 10;

  optional uint64 BuyIn = 11;
  repeated string AllowedAssets = 12;
  string AllowedDifficulty = 13;
  string Broker = 14;
  optional uint64 InitialPrizePool = 15;

  bool AutoStartWhenFull = 16;
  uint64 ContestStartDateTimeUnixMs = 17;
  
  ContestEngineContestRewardSetupGrpcModel RewardConfiguration = 18;
  optional string Description = 19;
}

message ContestEngineUpdateContestGrpcRequest {
  string UserId = 1;
  string Name = 2;
  double CreatorCommission = 3;

  // FIX: counts should be integers
  uint32 MinParticipants = 4;
  uint32 MaxParticipants = 5;

  optional uint32 MinTeamSize = 6;
  optional uint32 MaxTeamSize = 7;

  double ContestLeverage = 8;
  double ContestInitialBalance = 9;
  uint32 ContestDurationMinutes = 10;

  optional uint64 BuyIn = 11;
  repeated string AllowedAssets = 12;
  string AllowedDifficulty = 13;
  string Broker = 14;
  optional uint64 InitialPrizePool = 15;

  bool AutoStartWhenFull = 16;
  optional uint64 ContestStartDateTimeUnixMs = 17; // added for parity with create
  string ContestId = 18;

  ContestEngineContestRewardSetupGrpcModel RewardConfiguration = 19;
  optional string Description = 20;
}

message ContestEngineCreateContestGrpcResponse {
  oneof CreateContestResult {
    ContestEngineContestGrpcModel Contest = 1;
    ContestEngineErrorsGrpcModel Error = 2;
  }
}

message ContestEngineUpdateContestGrpcResponse {
  oneof UpdateContestResult {
    ContestEngineContestGrpcModel Contest = 1;
    ContestEngineErrorsGrpcModel Error = 2;
  }
}

message ContestEngineContestActionGrpcRequest {
  string ContestId = 1;
  string UserId = 2;
}

message ContestEngineGetContestRegistrationsGrpcRequest {
  string ContestId = 1;
}

message ContestEngineRegisterToContestGrpcRequest {
  string ContestId = 1;
  string UserId = 2;
}

message ContestEnginePublishContestGrpcRequest {
  string ContestId = 1;
  string UserId = 2;
}

message ContestEnginePublishContestGrpcResponse {
  oneof PublishContestResult {
    ContestEngineContestGrpcModel Contest = 1;
    ContestEngineErrorsGrpcModel Error = 2;
  }
}

message ContestEngineCancelContestGrpcRequest {
  string ContestId = 1;
  string UserId = 2;
}

message ContestEngineCancelContestGrpcResponse {
  oneof CancelContestResult {
    ContestEngineContestGrpcModel Contest = 1;
    ContestEngineErrorGrpcModel Error = 2;
  }
}

message ContestEngineRegisterToContestGrpcResponse {
  oneof RegisterToContestResult {
    ContestEngineContestRegistrationGrpcModel Registration = 1;
    ContestEngineErrorGrpcModel Error = 2;
  }
}

message ContestEngineUpdateContestRegistrationGrpcRequest {
  string ContestId = 1;
  string UserId = 2;
}

message ContestEngineUpdateContestRegistrationGrpcResponse {
  oneof UpdateContestRegistrationResult {
    ContestEngineContestRegistrationGrpcModel Registration = 1;
    ContestEngineErrorGrpcModel Error = 2;
  }
}

message ContestEngineCancelRegistrationGrpcRequest {
  string UserId = 1;
  string ContestId = 2;
}

message ContestEngineCancelContestRegistrationGrpcResponse {
  oneof CancelContestRegistrationResult {
    ContestEngineContestRegistrationGrpcModel Registration = 1;
    ContestEngineErrorGrpcModel Error = 2;
  }
}

enum ContestEngineContestParticipantStatus {
  InProcess = 0;
  Finished = 1;
  Disqualified = 2;
}

message ContestEngineContestParticipantGrpcModel {
  string ContestId = 1;
  string UserId = 2;

  ContestEngineContestParticipantStatus Status = 3;

  string ContestAccount = 4;

  // timestamps
  optional uint64 JoinedAtUnixMs = 5;      // from registration
  optional uint64 ActivatedAtUnixMs = 6;   // when contest started for the user
  optional uint64 LastUpdatedUnixMs = 7;

}

message ContestEngineGetMyContestParticipantGrpcRequest {
  string ContestId = 1;
  string UserId = 2;
}

message ContestEngineGetMyContestParticipantGrpcResponse {
  oneof GetMyContestParticipantResult {
    ContestEngineContestParticipantGrpcModel Participant = 1;
    ContestEngineErrorGrpcModel Error = 2;
  }
}

message ContestEngineGetContestParticipantsGrpcRequest {
  string ContestId = 1;
}

message ContestEngineContestLeaderboardEntryGrpcModel {
  string ContestId = 1;
  string UserId = 2;

  int32 Rank = 3;
  double Equity = 4;
  double Pnl = 5;
  double ReturnPercent = 6;

  optional string TeamId = 7;
}

message ContestEngineGetContestLeaderboardGrpcRequest {
  string ContestId = 1;
}

// -------------------
// DICTS / SETTINGS
// -------------------

message ContestEngineContestDifficultyGrpcModel {
  string Id = 1;
  string Name = 2;
}

message ContestEngineInsertOrReplaceContestDifficultyGrpcResponse {
  oneof InsertOrReplaceContestDifficultyResult {
    ContestEngineContestDifficultyGrpcModel Difficulty = 1;
    ContestEngineErrorGrpcModel Error = 2;
  }
}

message ContestEngineContestInstrumentGroupGrpcModel {
  string Id = 1;
  string Name = 2;
}

message ContestEngineInsertOrReplaceContestInstrumentGroupGrpcResponse {
  oneof InsertOrReplaceContestInstrumentGroupResult {
    ContestEngineContestInstrumentGroupGrpcModel InstrumentGroup = 1;
    ContestEngineErrorGrpcModel Error = 2;
  }
}

message ContestEngineContestInstrumentGrpcModel {
  string Id = 1;
  string Name = 2;
  string InstrumentGroupId = 3;
}

message ContestEngineInsertOrReplaceContestInstrumentGrpcResponse {
  oneof InsertOrReplaceContestInstrumentResult {
    ContestEngineContestInstrumentGrpcModel Instrument = 1;
    ContestEngineErrorGrpcModel Error = 2;
  }
}

message ContestEngineContestSettingsGrpcModel {
  string Name = 1;
  string PlatformCommission = 2;
  string MinCreatorCommissionPercent = 3;
  string MaxCreatorCommissionPercent = 4;
  string MinContestParticipants = 5;
  string MaxContestParticipants = 6;
  string MinLeverage = 7;
  string MaxLeverage = 8;
  string MinInitialBalance = 9;
  string MaxInitialBalance = 10;
  uint32 MinContestDurationMinutes = 11;
  uint32 MaxContestDurationMinutes = 12;
  string MinContestBuyIn = 13;
  string MaxContestBuyIn = 14;
  repeated string AllowedDifficulties = 15;
  repeated string AllowedBrokers = 16;
  repeated string AllowedInstruments = 17;
  optional uint64 MaxInitialPrizePool = 18;
}

message ContestEngineInsertOrReplaceContestSettingsGrpcResponse {
  oneof InsertOrReplaceContestSettingsResult {
    ContestEngineContestSettingsGrpcModel Settings = 1;
    ContestEngineErrorGrpcModel Error = 2;
  }
}

message ContestEngineGetContestsGrpcRequest{
  optional ContestEngineContestGrpcStatus Status = 1;
  optional string CreatorId = 2;
  optional uint64 DateFrom = 3;
  optional uint64 DateTo = 4;
  optional string ContestId = 5;
}

service ContestEngineGrpcService {
  rpc CreateContest(ContestEngineCreateContestGrpcRequest) returns (ContestEngineCreateContestGrpcResponse);
  rpc UpdateContest(ContestEngineUpdateContestGrpcRequest) returns (ContestEngineUpdateContestGrpcResponse);

  rpc PublishContest(ContestEnginePublishContestGrpcRequest) returns (ContestEnginePublishContestGrpcResponse);
  rpc CancelContest(ContestEngineCancelContestGrpcRequest) returns (ContestEngineCancelContestGrpcResponse);

  rpc GetContestRegistrations(ContestEngineGetContestRegistrationsGrpcRequest) returns (stream ContestEngineContestRegistrationGrpcModel);
  rpc RegisterToContest(ContestEngineRegisterToContestGrpcRequest) returns (ContestEngineRegisterToContestGrpcResponse);
  rpc CancelContestRegistration(ContestEngineCancelRegistrationGrpcRequest) returns (ContestEngineCancelContestRegistrationGrpcResponse);
  rpc UpdateContestRegistration(ContestEngineUpdateContestRegistrationGrpcRequest) returns (ContestEngineUpdateContestRegistrationGrpcResponse);

  rpc GetMyContestParticipant(ContestEngineGetMyContestParticipantGrpcRequest) returns (ContestEngineGetMyContestParticipantGrpcResponse);
  rpc GetContestParticipants(ContestEngineGetContestParticipantsGrpcRequest) returns (stream ContestEngineContestParticipantGrpcModel);
  rpc GetContestLeaderboard(ContestEngineGetContestLeaderboardGrpcRequest) returns (stream ContestEngineContestLeaderboardEntryGrpcModel);

  rpc InsertOrReplaceContestDifficulty(ContestEngineContestDifficultyGrpcModel) returns (ContestEngineInsertOrReplaceContestDifficultyGrpcResponse);
  rpc InsertOrReplaceContestInstrumentGroup(ContestEngineContestInstrumentGroupGrpcModel) returns (ContestEngineInsertOrReplaceContestInstrumentGroupGrpcResponse);
  rpc InsertOrReplaceContestInstrument(ContestEngineContestInstrumentGrpcModel) returns (ContestEngineInsertOrReplaceContestInstrumentGrpcResponse);
  rpc InsertOrReplaceContestSettings(ContestEngineContestSettingsGrpcModel) returns (ContestEngineInsertOrReplaceContestSettingsGrpcResponse);

  rpc GetContests(ContestEngineGetContestsGrpcRequest) returns (stream ContestEngineContestGrpcModel);

  rpc Ping(google.protobuf.Empty) returns (google.protobuf.Empty);
}
