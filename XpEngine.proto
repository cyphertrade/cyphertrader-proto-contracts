syntax = "proto3";
package xp_engine;
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

// ========== Errors and Enums ==========
enum XpEngineGrpcErrorType {
    UNSPECIFIED = 0;
    EVAL_EXP_ERROR = 1;
    DATA_WRITER_ERROR = 2;
    VALIDATION_ERRORS = 3;
    DATABASE_ERROR = 4;
    SETTINGS_NOT_FOUND = 5;
    SERVICE_BUS_ERROR = 6;
}

message XpEngineGrpcError {
    XpEngineGrpcErrorType ErrorType = 1;
    optional string Message = 2;
}

enum XpEngineXpGrpcType {
    TRADER = 1;
    INFLUENCER = 2;
}

enum XpEngineXpTransactionSourceGrpc {
    MANUAL = 0;
    SYSTEM = 1;
    EVENT = 2;
}

// ========== Models ==========
// XP Progression Settings model
message XpEngineXpProgressionSettingsGrpcModel {
    string Name = 1;
    string Base = 2;  // base formula expression
    map<uint32, string> Progressive = 3;  // progressive formula settings
    google.protobuf.Timestamp CreatedAt = 4;
    google.protobuf.Timestamp UpdatedAt = 5;
}

message XpEngineUserXpStateGrpcModel {
    string UserId = 1;
    XpEngineXpGrpcType XpType = 2;
    uint32 CurrentLevel = 3;
    uint64 CurrentLevelXp = 4;
    google.protobuf.Timestamp LastUpdateDate = 5;
    google.protobuf.Timestamp CreateDate = 6;
    string LastUpdateProcessId = 7;
    string CreateProcessId = 8;
    uint64 NextLevelRequiredXp = 9;
}

message XpEngineUserXpStateTransactionGrpcModel {
    string Id = 1;
    XpEngineXpGrpcType XpType = 2;
    int64 XpDelta = 3;
    string ProcessId = 4;
    google.protobuf.Timestamp Date = 5;
    optional string ReferenceOperationId = 6;
    optional string Comment = 7;
    XpEngineXpTransactionSourceGrpc Source = 8;
    string UserId = 9;
}

message XpEngineInsertOrReplaceProgressionSettingsResponse{
    oneof InsertOrReplaceProgressionResult{
        XpEngineXpProgressionSettingsGrpcModel Progression = 1;
        XpEngineGrpcError Error = 2;

    }
}

// ========== Request-Response Pairs ==========
message XpEngineGetUserXpStateGrpcRequest {
    string UserId = 1;
    XpEngineXpGrpcType XpType = 2;
}

message XpEngineGetUserXpStatesGrpcRequest {
    string UserId = 1;
}

message XpEngineGetUserXpStateGrpcResponse {
    oneof GetUserXpStateResult {
        XpEngineUserXpStateGrpcModel UserXpState = 1;
        XpEngineGrpcError Error = 2;
    }
}

message XpEngineChangeUserXpStateGrpcRequest {
    string UserId = 1;
    XpEngineXpGrpcType XpType = 2;
    int64 Delta = 3;
    string ProcessId = 4;
}

message XpEngineChangeUserXpStateGrpcResponse {
    oneof ChangeUserXpStateResult {
        XpEngineChangeUserXpStateSuccessGrpc Success = 1;
        XpEngineGrpcError Error = 2;
    }
}

message XpEngineChangeUserXpStateSuccessGrpc {
    XpEngineUserXpStateGrpcModel NewState = 1;
    XpEngineUserXpStateTransactionGrpcModel Transaction = 2;
}

service XpEngineGrpcService{
    rpc InsertOrReplaceProgressionSettings(XpEngineXpProgressionSettingsGrpcModel) returns(XpEngineInsertOrReplaceProgressionSettingsResponse);
    rpc GetUserXpState(XpEngineGetUserXpStateGrpcRequest) returns(XpEngineGetUserXpStateGrpcResponse);
    rpc GetUserXpStates(XpEngineGetUserXpStatesGrpcRequest) returns(stream XpEngineUserXpStateGrpcModel);
    rpc ChangeUserXpState(XpEngineChangeUserXpStateGrpcRequest) returns(XpEngineChangeUserXpStateGrpcResponse);
    rpc Ping(google.protobuf.Empty) returns (google.protobuf.Empty);
}