syntax = "proto3";
package xp_engine;
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

// ========== Errors and Enums ==========
enum XpEngineGrpcErrorType {
    UNSPECIFIED = 0;
    EVAL_EXP_ERROR = 1;
    DATA_WRITER_ERROR = 2;
    VALIDATION_ERRORS = 3;
    DATABASE_ERROR = 4;
    SETTINGS_NOT_FOUND = 5;
}

message XpEngineGrpcError {
    XpEngineGrpcErrorType error_type = 1;
    optional string message = 2;
}

enum XpEngineXpGrpcType {
    PARTNER = 0;
    TRADER = 1;
    INFLUENCER = 2;
}

enum XpEngineXpTransactionSourceGrpc {
    MANUAL = 0;
    SYSTEM = 1;
    EVENT = 2;
}

// ========== Models ==========
// XP Progression Settings model
message XpEngineXpProgressionSettingsGrpcModel {
    string name = 1;
    string base = 2;  // base formula expression
    map<uint32, string> progressive = 3;  // progressive formula settings
    google.protobuf.Timestamp created_at = 4;
    google.protobuf.Timestamp updated_at = 5;
}

message XpEngineUserXpStateGrpcModel {
    string user_id = 1;
    XpEngineXpGrpcType xp_type = 2;
    uint32 current_level = 3;
    uint64 current_level_xp = 4;
    google.protobuf.Timestamp last_update_date = 5;
    google.protobuf.Timestamp create_date = 6;
    string last_update_process_id = 7;
    string create_process_id = 8;
}

message XpEngineUserXpStateTransactionGrpcModel {
    string id = 1;
    XpEngineXpGrpcType xp_type = 2;
    int64 xp_delta = 3;
    string process_id = 4;
    google.protobuf.Timestamp date = 5;
    optional string reference_operation_id = 6;
    optional string comment = 7;
    XpEngineXpTransactionSourceGrpc source = 8;
}

message XpEngineInsertOrReplaceProgressionSettingsResponse{
    oneof insert_or_replace_progression_result{
        XpEngineXpProgressionSettingsGrpcModel progression = 1;
        XpEngineGrpcError error = 2;

    }
}

// ========== Request-Response Pairs ==========
message XpEngineGetUserXpStateGrpcRequest {
    string user_id = 1;
    XpEngineXpGrpcType xp_type = 2;
}

message XpEngineGetUserXpStateGrpcResponse {
    oneof get_user_xp_state_result {
        XpEngineUserXpStateGrpcModel user_xp_state = 1;
        XpEngineGrpcError error = 2;
    }
}

message XpEngineChangeUserXpStateGrpcRequest {
    string user_id = 1;
    XpEngineXpGrpcType xp_type = 2;
    int64 delta = 3;
    string process_id = 4;
}

message XpEngineChangeUserXpStateGrpcResponse {
    oneof change_user_xp_state_result {
        XpEngineChangeUserXpStateSuccessGrpc success = 1;
        XpEngineGrpcError error = 2;
    }
}

message XpEngineChangeUserXpStateSuccessGrpc {
    XpEngineUserXpStateGrpcModel new_state = 1;
    XpEngineUserXpStateTransactionGrpcModel transaction = 2;
}

service XpEngineGrpcService{
    rpc InsertOrReplaceProgressionSettings(XpEngineXpProgressionSettingsGrpcModel) returns(XpEngineInsertOrReplaceProgressionSettingsResponse);
    rpc GetUserXpState(XpEngineGetUserXpStateGrpcRequest) returns(XpEngineGetUserXpStateGrpcResponse);
    rpc ChangeUserXpState(XpEngineChangeUserXpStateGrpcRequest) returns(XpEngineChangeUserXpStateGrpcResponse);
    rpc Ping(google.protobuf.Empty) returns (google.protobuf.Empty);
}