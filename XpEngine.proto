syntax = "proto3";
package xp_engine;
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";

// ========== Errors and Enums ==========
enum XpEngineGrpcErrorType {
    UNSPECIFIED = 0;
    EVAL_EXP_ERROR = 1;
    DATA_WRITER_ERROR = 2;
    VALIDATION_ERRORS = 3;
    DATABASE_ERROR = 4;
    SETTINGS_NOT_FOUND = 5;
}

message XpEngineGrpcError {
    XpEngineGrpcErrorType error_type = 1;
    optional string message = 2;
}

enum XpType {
    PARTNER = 0;
    TRADER = 1;
    INFLUENCER = 2;
}

enum XpTransactionSource {
    MANUAL = 0;
    SYSTEM = 1;
    EVENT = 2;
}

// ========== Models ==========
// XP Progression Settings model
message XpEngineXpProgressionSettingsGrpcModel {
    string name = 1;
    string base = 2;  // base formula expression
    map<uint32, string> progressive = 3;  // progressive formula settings
    google.protobuf.Timestamp created_at = 4;
    google.protobuf.Timestamp updated_at = 5;
}

message UserXpStateGrpcModel {
    string user_id = 1;
    XpType xp_type = 2;
    uint32 current_level = 3;
    uint64 current_level_xp = 4;
    google.protobuf.Timestamp last_update_date = 5;
    google.protobuf.Timestamp create_date = 6;
    string last_update_process_id = 7;
    string create_process_id = 8;
}

message UserXpStateTransactionGrpcModel {
    string id = 1;
    XpType xp_type = 2;
    int64 xp_delta = 3;
    string process_id = 4;
    google.protobuf.Timestamp date = 5;
    optional string reference_operation_id = 6;
    optional string comment = 7;
    XpTransactionSource source = 8;
}

message XpEngineInsertOrReplaceProgressionSettingsResponse{
    oneof insert_or_replace_progression_result{
        XpEngineXpProgressionSettingsGrpcModel progression = 1;
        XpEngineGrpcError error = 2;

    }
}

// ========== Request-Response Pairs ==========
message GetUserXpStateGrpcRequest {
    string user_id = 1;
    XpType xp_type = 2;
    bool lazy_init = 3;
}

message GetUserXpStateGrpcResponse {
    oneof get_user_xp_state_result {
        UserXpStateGrpcModel user_xp_state = 1;
        XpEngineGrpcError error = 2;
    }
}

message ChangeUserXpStateGrpcRequest {
    string user_id = 1;
    XpType xp_type = 2;
    int64 delta = 3;
    string process_id = 4;
}

message ChangeUserXpStateGrpcResponse {
    oneof change_user_xp_state_result {
        ChangeUserXpStateSuccess success = 1;
        XpEngineGrpcError error = 2;
    }
}

message ChangeUserXpStateSuccess {
    UserXpStateGrpcModel new_state = 1;
    UserXpStateTransactionGrpcModel transaction = 2;
}

service XpEngineGrpcService{
    rpc InsertOrReplaceProgressionSettings(XpEngineXpProgressionSettingsGrpcModel) returns(XpEngineInsertOrReplaceProgressionSettingsResponse);
    rpc GetUserXpState(GetUserXpStateGrpcRequest) returns(GetUserXpStateGrpcResponse);
    rpc ChangeUserXpState(ChangeUserXpStateGrpcRequest) returns(ChangeUserXpStateGrpcResponse);
    rpc Ping(google.protobuf.Empty) returns (google.protobuf.Empty);
}